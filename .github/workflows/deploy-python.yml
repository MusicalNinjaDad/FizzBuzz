name: Deploy Python
concurrency: ADO-twine

on:
  workflow_dispatch:
  push: 
    tags: "python-v*"

jobs:
  python-checks:
    uses: ./.github/workflows/python.yml

  rust-checks:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: 3.9
    - name: Test fizzbuzzo3
      run: cargo test --workspace

  builds:
    uses: musicalninjas/cibuildwheel-rust@v0.1.0

  publish:
    environment: ADO-Packages
    needs: [python-checks, rust-checks, builds]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/download-artifact@v4
      with:
        pattern: cibwru-*
        path: dist
        merge-multiple: true
    - name: Install tooling
      run: python -m pip install twine keyring artifacts-keyring
    - name: Upload to ADO
      env: 
        TWINE_REPOSITORY_URL: https://pkgs.dev.azure.com/MusicalNinjas/FizzBuzz/_packaging/FizzBuzz/pypi/upload/
        TWINE_USERNAME: FizzBuzz
        TWINE_PASSWORD: ${{ secrets.ADO_TOKEN }}
      run: twine upload --non-interactive dist/*